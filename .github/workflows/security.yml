name: Security Audit

on:
  schedule:
    # Run every Monday at 00:00 UTC
    - cron: '0 0 * * 1'
  workflow_dispatch:  # Allow manual trigger

jobs:
  dependency-audit:
    name: Dependency Audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Audit Python dependencies
        run: |
          cd backend
          pip install safety
          safety check --file requirements.txt --output json || true

      - name: Audit Node dependencies
        run: |
          cd frontend
          npm audit --audit-level=high || true

  secret-scan:
    name: Secret Scanning
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better detection

      - name: TruffleHog Secret Scan
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD

  container-scan:
    name: Container Security Scan
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build backend image
        run: |
          docker build -f docker/Dockerfile.backend.prod -t nusatrade-backend:scan .

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'nusatrade-backend:scan'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: 'trivy-results.sarif'

  notify:
    name: Notify Team
    runs-on: ubuntu-latest
    needs: [dependency-audit, secret-scan, container-scan]
    if: failure()

    steps:
      - name: Send alert
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          text: '⚠️ Security audit found issues! Check GitHub Actions.'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
